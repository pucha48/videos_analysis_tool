<!DOCTYPE html>
<html>
<head>
    <title>Video Frame Viewer</title>
    <style>
        .thumbnail { width: 220px; height: 180px; object-fit: cover; border: 1px solid #ccc; }
        .frame-cell { text-align: center; vertical-align: top; }
        .slider-row { margin-bottom: 10px; }
        .float-label { position: relative; top: -25px; left: 5px; color: yellow; text-shadow: 1px 1px 2px black; font-weight: bold; }
        .folder-label { font-weight: bold; margin-bottom: 2px; }
        .vertical-slider { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 20px; height: 500px; }
        .input-box { width: 50px; text-align: center; margin-top: 2px; }
        .row-flex { display: flex; align-items: flex-start; margin-bottom: 10px; }
        .main-flex { display: flex; }
        .vertical-bar-container { display: flex; flex-direction: column; align-items: center; margin-left: 20px; }
        .folder-select-bar { margin-bottom: 20px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Video Frame Viewer</h2>
    <div class="main-flex">
        <div style="flex: 1;">
            {% for row in rows %}
            <div class="row-flex">
                <div>
                    <div class="folder-label">{{ row.folder }}
                        <button onclick="saveLabellingGuide('{{ row.folder }}')">Save Labelling Guide</button>
                    </div>
                    <div style="display: flex;" class="slider-row" data-row-idx="{{ loop.index0 }}">
                        {% for frame in row.frames %}
                            <div class="frame-cell">
                                {% if frame %}
                                    <div style="position: relative;">
                                        <img class="thumbnail" src="{{ frame.img_url }}">
                                        <div class="float-label">{{ frame.float_val }}</div>
                                    </div>
                                    <div style="font-size: 10px;">{{ frame.filename }}</div>
                                    <input class="input-box"
                                           type="number" min="0" max="1" step="0.01"
                                           value="{{ frame.box_val }}"
                                           data-folder="{{ row.folder }}"
                                           data-frame="{{ frame.filename }}"
                                           onchange="saveBoxValue(this)">
                                {% endif %}
                            </div>
                        {% endfor %}
                        <!-- Plot as the last cell, same size as thumbnail -->
                        <div class="frame-cell" style="display: flex; flex-direction: column; align-items: center;">
                            <canvas id="plot_{{ loop.index0 }}" width="220" height="180"></canvas>
                            <div style="font-size: 10px;">Box Plot</div>
                        </div>
                    </div>
                    {% if row.max_start > 0 %}
                    <input 
                        type="range" 
                        min="0" 
                        max="{{ row.max_start }}" 
                        value="{{ row.start }}" 
                        id="frame_slider_{{ loop.index0 }}" 
                        oninput="updateFrameSlider({{ loop.index0 }}, this.value)"
                        style="width: {{ 130 * row.frames|length }}px;"
                    >
                    {% else %}
                    <!-- Hide slider if not needed -->
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script>
    let charts = {};

    function renderPlot(rowIdx, labels, values) {
        const ctx = document.getElementById('plot_' + rowIdx).getContext('2d');
        if (charts[rowIdx]) {
            charts[rowIdx].data.labels = labels;
            charts[rowIdx].data.datasets[0].data = values;
            charts[rowIdx].update();
        } else {
            charts[rowIdx] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '',
                        data: values,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0,0,255,0.1)',
                        pointRadius: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { min: 0, max: 1, display: false }
                    }
                }
            });
        }
    }

    // Initial plot rendering for all frames in each row
    window.addEventListener('DOMContentLoaded', function() {
        {% for row in rows %}
            fetch(`/get_labels?folder={{ row.folder }}`)
                .then(resp => resp.json())
                .then(labels => {
                    let labelsArr = Object.keys(labels);
                    let valuesArr = Object.values(labels).map(parseFloat);
                    renderPlot({{ loop.index0 }}, labelsArr, valuesArr);
                });
        {% endfor %}
        attachSliderListeners();
        // Do NOT call reinitPlots() here
    });

    // Update plot after user input
    function saveBoxValue(input) {
        fetch('/save_label', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                folder: input.getAttribute('data-folder'),
                frame: input.getAttribute('data-frame'),
                value: input.value
            })
        }).then(response => response.json())
          .then(data => {
            // After saving, fetch new labels and update the plot
            let folder = input.getAttribute('data-folder');
            let rowDiv = input.closest('.slider-row');
            let rowIdx = rowDiv ? rowDiv.getAttribute('data-row-idx') : 0;
            fetch(`/get_labels?folder=${encodeURIComponent(folder)}`)
                .then(resp => resp.json())
                .then(labels => {
                    let labelsArr = Object.keys(labels);
                    let valuesArr = Object.values(labels).map(parseFloat);
                    renderPlot(rowIdx, labelsArr, valuesArr);
                });
          });
    }

    // Attach slider event listeners dynamically
    function attachSliderListeners() {
        // Frame sliders
        document.querySelectorAll('input[id^="frame_slider_"]').forEach((slider, idx) => {
            slider.oninput = function() {
                updateFrameSlider(idx, this.value);
            };
        });
    }

    function updateFrameSlider(row, val) {
        // Get all frame slider values from DOM
        let frame_starts = [];
        document.querySelectorAll('input[id^="frame_slider_"]').forEach((slider, idx) => {
            frame_starts.push(idx == row ? val : slider.value);
        });
        let params = new URLSearchParams(window.location.search);
        params.delete('frame_start');
        frame_starts.forEach(v => params.append('frame_start', v));
        fetch(`/?${params.toString()}`)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newMainFlex = doc.querySelector('.main-flex');
                document.querySelector('.main-flex').replaceWith(newMainFlex);
                attachSliderListeners();
                reinitPlots();
            });
    }
    function reinitPlots() {
        document.querySelectorAll('canvas[id^="plot_"]').forEach((canvas, idx) => {
            let folder = canvas.closest('.row-flex').querySelector('.folder-label').textContent.trim();
            fetch(`/get_labels?folder=${encodeURIComponent(folder)}`)
                .then(resp => resp.json())
                .then(labels => {
                    let labelsArr = Object.keys(labels);
                    let valuesArr = Object.values(labels).map(parseFloat);
                    // Always create a new Chart for the new canvas
                    new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: labelsArr,
                            datasets: [{
                                label: '',
                                data: valuesArr,
                                borderColor: 'blue',
                                backgroundColor: 'rgba(0,0,255,0.1)',
                                pointRadius: 2,
                                fill: false,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { min: 0, max: 1, display: false } }
                        }
                    });
                });
        });
    }

    // Folder selection logic (client-side only, for UI feedback)
    function selectDataFolder() {
        document.getElementById('data-folder-input').click();
    }
    function selectLabelsFolder() {
        document.getElementById('labels-folder-input').click();
    }
    function setDataFolder(event) {
        let folder = event.target.files.length > 0 ? event.target.files[0].webkitRelativePath.split('/')[0] : '';
        document.getElementById('current-folders').innerText = 'Data Folder: ' + folder;
        // To actually use this folder on the backend, you would need to send it to the server and reload.
    }
    function setLabelsFolder(event) {
        let folder = event.target.files.length > 0 ? event.target.files[0].webkitRelativePath.split('/')[0] : '';
        let current = document.getElementById('current-folders').innerText;
        document.getElementById('current-folders').innerText = current + ' | Labels Folder: ' + folder;
        // To actually use this folder on the backend, you would need to send it to the server and reload.
    }

    function saveLabellingGuide(folder) {
        fetch('/save_labelling_guide', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({folder: folder})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Labelling guide saved!');
            } else {
                alert('Error: ' + (data.error || 'Could not save labelling guide.'));
            }
        });
    }
    </script>
</body>
</html>